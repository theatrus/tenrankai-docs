name: Test Tenrankai Marketing Site

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: 1.89.0
    
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          tenrankai/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        # Build tools for AVIF
        sudo apt-get install -y nasm ninja-build meson cmake pkg-config
        # libheif dependencies
        sudo apt-get install -y libde265-dev libx265-dev libaom-dev
        # Build libheif from source (need >= 1.21 for libheif-rs)
        git clone --depth 1 --branch v1.21.1 https://github.com/strukturag/libheif.git /tmp/libheif
        cd /tmp/libheif
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DWITH_EXAMPLES=OFF
        make -j$(nproc)
        sudo make install
        sudo ldconfig
        rm -rf /tmp/libheif

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install frontend dependencies
      run: |
        cd tenrankai
        npm ci
        cd admin && npm ci

    - name: Build Tenrankai
      run: |
        cd tenrankai
        cargo build --release
    
    - name: Run tests
      run: |
        # Use dev config which doesn't have pre-generation blocking startup
        uv run test_tenrankai_site.py --config config.dev.toml

    - name: Test ConfigStorage config
      run: |
        # Test that ConfigStorage config starts (with quick exit)
        cd tenrankai-dot-com
        ../tenrankai/target/release/tenrankai --config config.toml --quit-after 5 || true

        # Test that production config parses (will fail on paths)
        ../tenrankai/target/release/tenrankai --config config.production.toml --quit-after 2 || true
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: server-logs
        path: tenrankai-dot-com/server.log

  test-content:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Check required files
      run: |
        # Check config files
        for config in config.toml config.dev.toml config.production.toml; do
          if [ -f "tenrankai-dot-com/$config" ]; then
            echo "✓ Found $config"
          else
            echo "✗ Missing $config"
            exit 1
          fi
        done
        
        # Check templates
        for template in index.html.liquid about.html.liquid features.html.liquid; do
          if [ -f "tenrankai-dot-com/templates/pages/$template" ]; then
            echo "✓ Found $template"
          else
            echo "✗ Missing $template"
            exit 1
          fi
        done
        
        # Check documentation
        for doc in 00-quick-start.md 01-installation.md 02-core-concepts.md; do
          if [ -f "tenrankai-dot-com/posts/docs/$doc" ]; then
            echo "✓ Found $doc"
          else
            echo "✗ Missing $doc"
            exit 1
          fi
        done
    
    - name: Validate TOML configs
      run: |
        pip install toml -q
        python3 scripts/validate_config.py